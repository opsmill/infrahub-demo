!
! Arista EOS VXLAN/EVPN Spine Configuration
! Device: {{ hostname }}
! Generated for Arista EOS
!

hostname {{ hostname }}

! Configure spanning tree mode
spanning-tree mode mstp

! Configure loopback interfaces
{% for interface in interface_roles.loopback %}
interface {{ interface.name }}
{% if interface.name == 'loopback0' %}
   description Underlay Routing Loopback
{% elif interface.name == 'loopback1' %}
   description VTEP Loopback Interface
{% elif interface.description %}
   description {{ interface.description }}
{% else %}
   description Routing Loopback
{% endif %}
{% if interface.ip_address %}
   ip address {{ interface.ip_address | replace('/24', '/32') }}
{% endif %}
{% if interface.name == 'loopback0' %}
   ospf area {{ ospf.area or "0.0.0.0" }}
{% elif interface.name != 'loopback1' %}
{#- loopback1 is NOT in OSPF, used only for iBGP EVPN overlay -#}
   ospf area {{ ospf.area or "0.0.0.0" }}
{% endif %}

{% endfor %}

! Configure OSPF
router ospf {{ ospf.process_id or 'Underlay' }}
   router-id {{ ospf.router_id or loopbacks.loopback0 }}
   passive-interface default
   no passive-interface Ethernet1
   no passive-interface Ethernet2
   max-lsa 12000

! Configure underlay interfaces
{% for interface in interface_roles.all_downlink %}
interface {{ interface.name }}
{% if interface.description %}
   description {{ interface.description }}
{% else %}
   description Link to Leaf
{% endif %}
   mtu {{ interface.mtu or 9214 }}
   no switchport
   ip unnumbered Loopback0
   ospf area {{ ospf.area or "0.0.0.0" }}
   ospf network point-to-point

{% endfor %}

! Configure BGP
router bgp {{ bgp.local_as }}
   router-id {{ bgp.router_id or loopbacks.loopback0 }}
   no bgp default ipv4-unicast
   distance bgp 20 200 200
   maximum-paths 4 ecmp 64

{# BGP listen range for EVPN overlay clients #}
   bgp listen range 10.0.0.0/8 peer-group EVPN-OVERLAY-PEERS remote-as {{ bgp.local_as }}

{# Configure peer groups for EVPN overlay #}
   peer-group EVPN-OVERLAY-PEERS remote-as {{ bgp.local_as }}
   peer-group EVPN-OVERLAY-PEERS update-source Loopback0
   peer-group EVPN-OVERLAY-PEERS send-community extended
   peer-group EVPN-OVERLAY-PEERS maximum-routes 0

{# Configure BGP neighbors from enhanced transform data #}
{% for neighbor in bgp.neighbors %}
   ! {{ neighbor.description or 'BGP Neighbor' }} (Route Reflector Client)
   neighbor {{ neighbor.remote_ip.split('/')[0] }} peer-group EVPN-OVERLAY-PEERS
   neighbor {{ neighbor.remote_ip.split('/')[0] }} description {{ neighbor.description or 'BGP Neighbor' }}
{% endfor %}

   address-family ipv4
      redistribute connected route-map RM-CONN-2-BGP

   address-family evpn
      peer-group EVPN-OVERLAY-PEERS activate
{# Configure route reflector clients for EVPN overlay #}
{% for neighbor in bgp.neighbors %}
      neighbor {{ neighbor.remote_ip.split('/')[0] }} route-reflector-client
{% endfor %}

! Configure route-maps
route-map RM-CONN-2-BGP permit 10
   match interface Loopback0

! End of configuration
