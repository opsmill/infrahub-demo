#
# Cloud Security Service Configuration
# Device: {{ data.name }}
# Provider: {{ data.device_type.manufacturer.name }}
# Platform: {{ data.device_type.platform.name }}
# Service Type: {{ data.cloud_security_service.service_type if data.cloud_security_service else 'N/A' }}
# Integration Mode: {{ data.cloud_integration_mode }}
#

# ============================================================================
# CLOUD SECURITY SERVICE CONFIGURATION
# ============================================================================

# Service Configuration
service_name: {{ data.name }}
provider: {{ data.device_type.manufacturer.name }}
platform: {{ data.device_type.platform.name }}
{%- if data.cloud_security_service %}
tenant_id: {{ data.cloud_security_service.tenant_id }}
api_endpoint: {{ data.cloud_security_service.api_endpoint }}
service_type: {{ data.cloud_security_service.service_type }}
cloud_region: {{ data.cloud_security_service.cloud_region if data.cloud_security_service.cloud_region else 'global' }}
{%- endif %}

# Device Configuration
integration_mode: {{ data.cloud_integration_mode }}
backup_mode: {{ data.backup_mode }}
cloud_security_enabled: {{ data.cloud_security_enabled }}

{%- if data.primary_gateway %}
# Primary Gateway Configuration
primary_gateway:
  name: {{ data.primary_gateway.name }}
  type: {{ data.primary_gateway.gateway_type }}
  endpoint: {{ data.primary_gateway.endpoint_address if data.primary_gateway.endpoint_address else 'auto-discovery' }}
  city: {{ data.primary_gateway.city if data.primary_gateway.city else 'unknown' }}
  country: {{ data.primary_gateway.country if data.primary_gateway.country else 'unknown' }}
  status: {{ data.primary_gateway.status }}
{%- endif %}

{%- if data.cloud_security_service and data.cloud_security_service.gateways %}
# Available Gateways
gateways:
{%- for gateway in data.cloud_security_service.gateways %}
  - name: {{ gateway.name }}
    type: {{ gateway.gateway_type }}
    location: "{{ gateway.city if gateway.city else 'Unknown' }}, {{ gateway.country if gateway.country else 'Unknown' }}"
    endpoint: {{ gateway.endpoint_address if gateway.endpoint_address else 'auto-discovery' }}
    capacity_mbps: {{ gateway.capacity_mbps if gateway.capacity_mbps else 'unlimited' }}
    status: {{ gateway.status }}
    {%- if gateway.security_zone %}
    security_zone: {{ gateway.security_zone.name }}
    trust_level: {{ gateway.security_zone.trust_level if gateway.security_zone.trust_level else 50 }}
    {%- endif %}
{%- endfor %}
{%- endif %}

# ============================================================================
# POLICY CONFIGURATION
# ============================================================================

{%- if data.cloud_security_service %}
{%- set policies = [] %}
{%- for policy in data.cloud_security_service.policies if data.cloud_security_service.policies %}
{%- set _ = policies.append(policy) %}
{%- endfor %}

{%- if policies %}
# Security Policies
policies:
{%- for policy in policies | sort(attribute='priority') %}
  - name: {{ policy.name }}
    category: {{ policy.policy_category }}
    enforcement: {{ policy.enforcement_mode }}
    priority: {{ policy.priority }}
    enabled: {{ policy.enabled }}
    log_enabled: {{ policy.log_enabled }}
    {%- if policy.description %}
    description: "{{ policy.description }}"
    {%- endif %}

    # Source Configuration
    {%- if policy.source_zones %}
    source_zones:
    {%- for zone in policy.source_zones %}
      - {{ zone.name }}
    {%- endfor %}
    {%- endif %}

    {%- if policy.source_addresses %}
    source_addresses:
    {%- for addr in policy.source_addresses %}
      - {{ addr.name }}
    {%- endfor %}
    {%- endif %}

    {%- if policy.source_gateways %}
    source_gateways:
    {%- for gw in policy.source_gateways %}
      - {{ gw.name }}
    {%- endfor %}
    {%- endif %}

    # Destination Configuration
    {%- if policy.destination_zones %}
    destination_zones:
    {%- for zone in policy.destination_zones %}
      - {{ zone.name }}
    {%- endfor %}
    {%- endif %}

    {%- if policy.destination_addresses %}
    destination_addresses:
    {%- for addr in policy.destination_addresses %}
      - {{ addr.name }}
    {%- endfor %}
    {%- endif %}

    {%- if policy.destination_gateways %}
    destination_gateways:
    {%- for gw in policy.destination_gateways %}
      - {{ gw.name }}
    {%- endfor %}
    {%- endif %}

    # Service Configuration
    {%- if policy.services %}
    services:
    {%- for service in policy.services %}
      - name: {{ service.name }}
        port: {{ service.port if service.port else 'any' }}
        protocol: {{ service.protocol }}
    {%- endfor %}
    {%- endif %}

    # Application Configuration
    {%- if policy.applications %}
    applications:
    {%- for app in policy.applications %}
      - name: {{ app.name }}
        category: {{ app.category if app.category else 'unknown' }}
        risk_level: {{ app.risk_level if app.risk_level else 1 }}
    {%- endfor %}
    {%- endif %}

    # URL Categories
    {%- if policy.url_categories %}
    url_categories:
    {%- for cat in policy.url_categories %}
      - name: {{ cat.name }}
        risk_level: {{ cat.risk_level }}
    {%- endfor %}
    {%- endif %}

    # Security Profile
    {%- if policy.security_profile %}
    security_profile:
      name: {{ policy.security_profile.name }}
      antivirus: {{ policy.security_profile.antivirus_enabled }}
      ips: {{ policy.security_profile.ips_enabled }}
      url_filtering: {{ policy.security_profile.url_filtering_enabled }}
    {%- endif %}

    # Schedule
    {%- if policy.schedule %}
    schedule:
      name: {{ policy.schedule.name }}
      days: {{ policy.schedule.days_of_week }}
      start_time: {{ policy.schedule.start_time }}
      end_time: {{ policy.schedule.end_time }}
      timezone: {{ policy.schedule.timezone }}
    {%- endif %}

{%- endfor %}
{%- endif %}
{%- endif %}

# ============================================================================
# PROVIDER-SPECIFIC CONFIGURATION
# ============================================================================

# Zscaler Configuration
{%- if data.device_type.manufacturer.name == 'Zscaler' %}
zscaler:
  cloud: {{ data.cloud_security_service.cloud_region if data.cloud_security_service and data.cloud_security_service.cloud_region else 'zscaler.net' }}
  {%- if data.cloud_integration_mode == 'tunnel' %}
  tunnel_config:
    type: ipsec
    authentication: psk
    encryption: aes256
    integrity: sha256
  {%- elif data.cloud_integration_mode == 'proxy' %}
  proxy_config:
    port: 80
    ssl_port: 443
    pac_file: auto
  {%- endif %}
{%- endif %}

# Prisma Access Configuration
{%- if data.device_type.manufacturer.name == 'Palo Alto Networks' %}
prisma:
  region: {{ data.cloud_security_service.cloud_region if data.cloud_security_service and data.cloud_security_service.cloud_region else 'us-east-1' }}
  {%- if data.cloud_integration_mode == 'tunnel' %}
  remote_networks:
    bgp_peer: auto
    qos_enabled: true
    bandwidth_allocation: auto
  {%- endif %}
{%- endif %}

# Cisco Umbrella Configuration
{%- if data.device_type.manufacturer.name == 'Cisco' and 'Umbrella' in data.device_type.platform.name %}
umbrella:
  organization_id: {{ data.cloud_security_service.tenant_id if data.cloud_security_service else 'auto' }}
  {%- if data.cloud_integration_mode == 'dns_redirect' %}
  dns_config:
    primary_dns: 208.67.222.222
    secondary_dns: 208.67.220.220
    anycast: true
  {%- endif %}
{%- endif %}

# Cloudflare Configuration
{%- if data.device_type.manufacturer.name == 'Cloudflare' %}
cloudflare:
  team_name: {{ data.cloud_security_service.tenant_id if data.cloud_security_service else 'auto' }}
  {%- if data.cloud_integration_mode == 'tunnel' %}
  tunnel_config:
    tunnel_type: cloudflared
    ingress_rules: auto
    load_balancing: true
  {%- endif %}
{%- endif %}

# ============================================================================
# MONITORING AND HEALTH CHECKS
# ============================================================================

monitoring:
  health_check_interval: 30
  gateway_status_check: true
  policy_sync_check: true
  bandwidth_monitoring: true

logging:
  level: info
  destinations:
    - syslog
    - api
  format: json

# ============================================================================
# END OF CONFIGURATION
# ============================================================================