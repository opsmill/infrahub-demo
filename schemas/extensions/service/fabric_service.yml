# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
---
version: "1.0"

nodes:
  - name: VxlanFabric
    namespace: Service
    description: "VXLAN Fabric service for data center overlay networking"
    label: VXLAN Fabric
    icon: "carbon:network-3"
    menu_placement: ServiceGeneric
    inherit_from:
      - ServiceGeneric
    attributes:
      - name: fabric_id
        label: Fabric ID
        kind: Number
        optional: false
        order_weight: 10
        unique: true
      - name: underlay_protocol
        label: Underlay Protocol
        kind: Dropdown
        optional: false
        order_weight: 11
        choices:
          - name: ospf
            label: OSPF
            description: "OSPF as underlay IGP"
            color: "#7fbf7f"
          - name: isis
            label: IS-IS
            description: "IS-IS as underlay IGP"
            color: "#7fbfbf"
          - name: bgp_spine_leaf
            label: BGP Spine-Leaf
            description: "BGP-only underlay"
            color: "#bf7fbf"
      - name: overlay_protocol
        label: Overlay Protocol
        kind: Dropdown
        optional: false
        order_weight: 12
        choices:
          - name: evpn
            label: EVPN
            description: "EVPN control plane"
            color: "#7fbf7f"
          - name: vxlan_flood_learn
            label: VXLAN Flood & Learn
            description: "Multicast-based VXLAN"
            color: "#bfbfbf"
      - name: spine_asn
        label: Spine ASN
        kind: Number
        optional: false
        order_weight: 13
      - name: leaf_asn_range_start
        label: Leaf ASN Range Start
        kind: Number
        optional: false
        order_weight: 14
      - name: leaf_asn_range_end
        label: Leaf ASN Range End
        kind: Number
        optional: false
        order_weight: 15
      - name: vni_range_start
        label: VNI Range Start
        kind: Number
        optional: false
        order_weight: 16
      - name: vni_range_end
        label: VNI Range End
        kind: Number
        optional: false
        order_weight: 17
      - name: multicast_group_base
        label: Multicast Group Base
        kind: IPAddress
        optional: true
        order_weight: 18
      - name: anycast_gateway_mac
        label: Anycast Gateway MAC
        kind: MacAddress
        optional: true
        order_weight: 19
    relationships:
      - name: spine_devices
        peer: DcimGenericDevice
        cardinality: many
        kind: Attribute
        optional: true
        order_weight: 20
      - name: leaf_devices
        peer: DcimGenericDevice
        cardinality: many
        kind: Attribute
        optional: true
        order_weight: 21
      - name: underlay_prefixes
        peer: IpamPrefix
        cardinality: many
        kind: Attribute
        optional: true
        order_weight: 22
      - name: overlay_segments
        peer: ServiceNetworkSegment
        cardinality: many
        kind: Component
        optional: true
        order_weight: 23

  - name: VxlanTenant
    namespace: Service
    description: "VXLAN tenant for multitenant segmentation"
    label: VXLAN Tenant
    icon: "carbon:network-2"
    menu_placement: ServiceGeneric
    inherit_from:
      - ServiceGeneric
    attributes:
      - name: tenant_id
        label: Tenant ID
        kind: Number
        optional: false
        order_weight: 10
        unique: true
      - name: vrf_name
        label: VRF Name
        kind: Text
        optional: false
        order_weight: 11
      - name: vrf_rd
        label: VRF Route Distinguisher
        kind: Text
        optional: true
        order_weight: 12
      - name: vrf_rt_import
        label: VRF Route Target Import
        kind: Text
        optional: true
        order_weight: 13
      - name: vrf_rt_export
        label: VRF Route Target Export
        kind: Text
        optional: true
        order_weight: 14
      - name: l3_vni
        label: Layer 3 VNI
        kind: Number
        optional: false
        order_weight: 15
    relationships:
      - name: customer
        peer: OrganizationGeneric
        cardinality: one
        kind: Attribute
        optional: false
        order_weight: 20
      - name: fabric
        peer: ServiceVxlanFabric
        cardinality: one
        kind: Attribute
        optional: false
        order_weight: 21
      - name: network_segments
        peer: ServiceNetworkSegment
        cardinality: many
        kind: Component
        optional: true
        order_weight: 22
      - name: gateway_interfaces
        peer: DcimInterface
        cardinality: many
        kind: Attribute
        optional: true
        order_weight: 23

extensions:
  nodes:
    - kind: ServiceNetworkSegment
      attributes:
        - name: l2_vni
          label: Layer 2 VNI
          kind: Number
          optional: true
          order_weight: 11
        - name: multicast_group
          label: Multicast Group
          kind: IPAddress
          optional: true
          order_weight: 12
        - name: is_l3_gateway
          label: Enable L3 Gateway
          kind: Boolean
          default_value: false
          optional: false
          order_weight: 13
        - name: gateway_ip
          label: Gateway IP Address
          kind: IPAddress
          optional: true
          order_weight: 14
      relationships:
        - name: tenant
          peer: ServiceVxlanTenant
          cardinality: one
          kind: Attribute
          optional: true
          order_weight: 30
        - name: fabric
          peer: ServiceVxlanFabric
          cardinality: one
          kind: Attribute
          optional: true
          order_weight: 31

    - kind: DcimGenericDevice
      relationships:
        - name: fabric_role
          peer: ServiceVxlanFabric
          cardinality: many
          kind: Attribute
          optional: true
          order_weight: 1450
          identifier: device_fabric_role

    - kind: IpamPrefix
      relationships:
        - name: fabric_underlay
          peer: ServiceVxlanFabric
          cardinality: many
          kind: Attribute
          optional: true
          order_weight: 1450
          identifier: prefix_fabric_underlay
