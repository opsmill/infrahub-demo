# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
---
version: "1.0"
generics:
  - name: RoutingService
    namespace: Service
    description: "Base service for all routing protocols that can be attached to devices."
    label: Network Routing Service
    icon: "carbon:network-4"
    default_filter: routing_domain__value
    order_by:
      - routing_domain__value
    display_labels:
      - routing_domain__value
    attributes:
      - name: routing_domain
        kind: Text
        description: "Name of the routing domain this service belongs to"
        order_weight: 1200
      - name: priority
        kind: Number
        description: "Priority of this routing service (higher number means higher priority)"
        default_value: 100
        order_weight: 1300
      - name: routing_instance
        kind: Text
        description: "Name of the routing instance on the device"
        optional: true
        order_weight: 1400
    relationships:
      - name: device
        peer: DcimGenericDevice
        optional: false
        cardinality: one
        kind: Attribute
        identifier: device_service
        order_weight: 1000

nodes:
  - name: OSPF
    namespace: Service
    description: "OSPF routing service that can be attached to devices"
    label: OSPF Service
    icon: "carbon:network-4-reference"
    menu_placement: ServiceGeneric
    include_in_menu: true
    inherit_from:
      - ServiceRoutingService
    attributes:
      - name: process_id
        kind: Text
        description: "OSPF process ID on the device"
        default_value: "1"
        order_weight: 1500
      - name: router_type
        kind: Dropdown
        description: "Type of OSPF router"
        choices:
          - name: abr
            label: Area Border Router
            description: "Connects multiple OSPF areas"
          - name: asbr
            label: Autonomous System Border Router
            description: "Connects to external routing domains"
          - name: internal
            label: Internal Router
            description: "Router within a single OSPF area"
        default_value: "internal"
        order_weight: 1600
      - name: reference_bandwidth
        kind: Number
        description: "Reference bandwidth for OSPF cost calculation (Mbps)"
        default_value: 100000
        optional: true
        order_weight: 1700
    relationships:
      - name: router_id
        peer: IpamIPAddress
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1500
      - name: area
        peer: ServiceOSPFArea
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1600
      - name: interfaces
        peer: DcimInterface
        optional: true
        cardinality: many
        kind: Generic
        order_weight: 1700

  - name: OSPFArea
    namespace: Service
    description: "OSPF area configuration"
    label: OSPF Area
    icon: "carbon:area"
    menu_placement: ServiceGeneric
    include_in_menu: true
    uniqueness_constraints:
      - ["name__value"]
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
      - area__value
    attributes:
      - name: name
        kind: Text
        description: "Name of the OSPF area"
        order_weight: 1000
      - name: area
        kind: Number
        description: "OSPF area number (0-4294967295)"
        order_weight: 1100
      - name: area_type
        kind: Dropdown
        description: "Type of OSPF area"
        choices:
          - name: standard
            label: Standard
            description: "Regular OSPF area"
          - name: stub
            label: Stub Area
            description: "Does not receive external routes"
          - name: nssa
            label: Not-So-Stubby Area
            description: "Can import some external routes"
          - name: totally_stubby
            label: Totally Stubby Area
            description: "Only receives default route"
        default_value: "standard"
        order_weight: 1200
      - name: description
        kind: Text
        description: "Description of the OSPF area"
        optional: true
        order_weight: 1300
    relationships:
      - name: ospf_interfaces
        peer: DcimInterface
        optional: true
        cardinality: many
        kind: Generic
        order_weight: 1400

  - name: BGPService
    namespace: Service
    description: "BGP routing service that can be attached to devices"
    label: BGP Service
    icon: "carbon:network-4-reference"
    menu_placement: ServiceGeneric
    include_in_menu: true
    inherit_from:
      - ServiceRoutingService
    attributes:
      - name: session_type
        kind: Dropdown
        description: "Type of BGP session"
        choices:
          - name: INTERNAL
            label: iBGP
            description: "Internal BGP session within the same AS"
          - name: EXTERNAL
            label: eBGP
            description: "External BGP session between different ASs"
        order_weight: 1500
      - name: multipath
        kind: Boolean
        description: "Whether BGP multipath is enabled"
        default_value: false
        optional: true
        order_weight: 1600
      - name: graceful_restart
        kind: Boolean
        description: "Whether graceful restart is enabled"
        default_value: true
        optional: true
        order_weight: 1700
    relationships:
      - name: router_id
        peer: IpamIPAddress
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1500
        identifier: bgp_router_id
      - name: local_as
        peer: ServiceAutonomousSystem
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1600
        identifier: bgp_local_as
      - name: remote_as
        peer: ServiceAutonomousSystem
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1700
        identifier: bgp_remote_as
      - name: local_ip
        peer: IpamIPAddress
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1800
        identifier: bgp_local_ip
      - name: remote_ip
        peer: IpamIPAddress
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1900
        identifier: bgp_remote_ip
      # - name: peer_group
      #   peer: ServiceBGPPeerGroup
      #   optional: true
      #   cardinality: one
      #   kind: Attribute
      #   order_weight: 2000

  - name: BGPPolicyService
    namespace: Service
    description: "BGP policy service for defining route policies"
    label: BGP Policy Service
    icon: "carbon:policy"
    menu_placement: ServiceGeneric
    include_in_menu: true
    inherit_from:
      - ServiceRoutingService
    attributes:
      - name: policy_type
        kind: Dropdown
        description: "Type of BGP policy"
        choices:
          - name: import
            label: Import Policy
            description: "Policy for routes received from peers"
          - name: export
            label: Export Policy
            description: "Policy for routes advertised to peers"
        order_weight: 1500
      - name: sequence
        kind: Number
        description: "Sequence number for policy processing order"
        default_value: 10
        order_weight: 1600
    relationships:
      - name: bgp_service
        peer: ServiceBGPService
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1500
        identifier: bgp_service
      - name: communities
        peer: RoutingBGPCommunity
        optional: true
        cardinality: many
        kind: Generic
        order_weight: 1600
      - name: prefix_lists
        peer: IpamPrefix
        optional: true
        cardinality: many
        kind: Generic
        order_weight: 1700

  - name: EVPNService
    namespace: Service
    description: "EVPN service for L2/L3 connectivity over VXLAN"
    label: EVPN Service
    icon: "carbon:virtual-network"
    menu_placement: ServiceGeneric
    include_in_menu: true
    inherit_from:
      - ServiceRoutingService
    attributes:
      - name: vni
        kind: Number
        description: "VXLAN Network Identifier"
        order_weight: 1500
      - name: replication_mode
        kind: Dropdown
        description: "Multicast or ingress replication mode"
        choices:
          - name: multicast
            label: Multicast
            description: "Uses multicast for BUM traffic"
          - name: ingress
            label: Ingress Replication
            description: "Uses ingress replication for BUM traffic"
        default_value: "ingress"
        order_weight: 1600
      - name: route_distinguisher
        kind: Text
        description: "Route distinguisher for this EVPN instance"
        optional: true
        order_weight: 1700
      - name: route_target_import
        kind: Text
        description: "Import route target"
        optional: true
        order_weight: 1800
      - name: route_target_export
        kind: Text
        description: "Export route target"
        optional: true
        order_weight: 1900
    relationships:
      - name: bgp_service
        peer: ServiceBGPService
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1500
      - name: vtep_ip
        peer: IpamIPAddress
        optional: false
        cardinality: one
        kind: Attribute
        order_weight: 1600
        identifier: evpn_services
      # - name: vlan
      #   peer: IpamVLAN
      #   optional: true
      #   cardinality: one
      #   kind: Attribute
      #   order_weight: 1700

  - name: UnderlaySupervisor
    namespace: Service
    description: "Service for managing and monitoring underlay routing"
    label: Underlay Supervisor
    icon: "carbon:data-vis-1"
    menu_placement: ServiceGeneric
    include_in_menu: true
    inherit_from:
      - ServiceRoutingService
    attributes:
      - name: name
        kind: Text
        description: "Name of the underlay supervisor"
        order_weight: 1000
      - name: description
        kind: Text
        description: "Description of the underlay supervisor"
        optional: true
        order_weight: 1100
      - name: topology_type
        kind: Dropdown
        description: "Type of network topology"
        choices:
          - name: spine_leaf
            label: Spine-Leaf
            description: "Two-tier Clos network"
          - name: spine_leaf_border
            label: Spine-Leaf-Border
            description: "Three-tier Clos network with border nodes"
          - name: mesh
            label: Full Mesh
            description: "Full mesh topology"
          - name: ring
            label: Ring
            description: "Ring topology"
        order_weight: 1200
    relationships:
      - name: ospf_areas
        peer: ServiceOSPFArea
        optional: true
        cardinality: many
        kind: Component
        order_weight: 1300
      - name: bgp_autonomous_systems
        peer: ServiceAutonomousSystem
        optional: true
        cardinality: many
        kind: Component
        order_weight: 1400
      - name: topology
        peer: TopologyDeployment
        optional: true
        cardinality: one
        kind: Attribute
        order_weight: 1500

  - name: AutonomousSystem
    namespace: Service
    description: "BGP Autonomous System"
    label: Autonomous System
    icon: "carbon:network-3"
    menu_placement: ServiceGeneric
    include_in_menu: true
    uniqueness_constraints:
      - ["name__value"]
      - ["asn__value"]
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
      - asn__value
    attributes:
      - name: name
        kind: Text
        description: "Name of the autonomous system"
        order_weight: 1000
      - name: asn
        kind: Number
        description: "AS number"
        order_weight: 1100
      - name: description
        kind: Text
        description: "Description of the autonomous system"
        optional: true
        order_weight: 1200
    relationships:
      - name: devices
        peer: DcimGenericDevice
        optional: true
        cardinality: many
        kind: Generic
        order_weight: 1300
      # - name: provider
      #   peer: ServiceCircuitProvider
      #   optional: true
      #   cardinality: one
      #   kind: Attribute
      #   order_weight: 1400

extensions:
  nodes:
    - kind: DcimGenericDevice
      relationships:
        - name: ospf_services
          peer: ServiceOSPFService
          optional: true
          cardinality: many
          kind: Generic
          identifier: ospf_services
          order_weight: 2500
        - name: bgp_services
          peer: ServiceBGPService
          optional: true
          cardinality: many
          kind: Generic
          identifier: bgp_services
          order_weight: 2600
        - name: evpn_services
          peer: ServiceEVPNService
          optional: true
          cardinality: many
          kind: Generic
          identifier: evpn_services
          order_weight: 2700

    - kind: DcimInterface
      relationships:
        - name: ospf_area_service
          peer: ServiceOSPFArea
          optional: true
          cardinality: one
          kind: Generic
          order_weight: 2000
